<div id="view-me" class="view">
    <div class="row">
        <div class="profile-name">{{ user.name }} <img id="shareMyCloudBtn" src="/static/images/iconsnap.png"></img></div>
    </div>

    <div class="row" id="myCanvasContainer">
        <canvas width="490" height="300" id="myCanvas">
            <div id="tags">
                <ul>
                    {% for key, value in tags.items() %}
                        <li><a href="#" data-weight="{{ value|length }}" title = "{{value[0].name}} {%if value|length > 1 %}and {{ value|length - 1 }} more {%endif%}tagged" style="font-weight:bold;">{{ key }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </canvas>
    </div>

    <div class="row">
        <button id="profile-view-manage-btn">Manage My Tags</button>
    </div>
</div>


<script>
    $(function () {
        $("#profile-view-manage-btn").click(function () {
            $(document).trigger("viewChanging", ["manage", {}]);
        });
        $("#shareMyCloudBtn").click(function () {
            var canvas = document.getElementById('myCanvas');
            $('.spinner-overlay').show();
            $.post('/store_image/', {data: canvas.toDataURL('image/png')}, function (response) {
                if (response.error) {
                    $('.spinner-overlay').hide();
                    alert(response.error);
                    return;
                }
                var uri = response['uri'];
                FB.api(
                        'me/objects/cstaaag:tag',
                        'post',
                        {'object': {
                            'og:url': 'https://taaag.sshz.org/tag_cloud/{{ user.id }}',
                            'og:title': '{{ user.name }}\'s Tag Cloud',
                            'og:type': 'cstaaag:tag',
                            'og:image': uri,
                            'fb:app_id': '687248731410966'
                        }},
                        function (response) {
                            $('.spinner-overlay').hide();
                            if (response.error) {
                                alert(response.error);
                                return;
                            }
                            FB.ui({
                                method: 'share_open_graph',
                                action_type: 'og.likes',
                                action_properties: JSON.stringify({
                                    object: response['id'],
                                })
                            }, function (response) {
                            });
                        }
                );
            });
        });
    });
</script>

{% set user_image = '/image_proxy/' ~ user.id %}
{% set on_view_me = True %}
{% include 'tag_cloud.html' %}
