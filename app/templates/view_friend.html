<div id="view-friend" class="view">
    <div class="row">
        <div class="profile-name">{{ friend.name }}</div>
    </div>

    <div class="row">
        <div id="tag-cloud" style="width: 100%; height: 250px;"></div>
        <img class="profile-pic" src="https://graph.facebook.com/{{ friend.id }}/picture?type=large"
             alter="profile pic">
    </div>

    <div class="row">
        <div class="profile-selectbar">
            <input class="profile-add-tag-input" id="inputDescription" maxlength="32"></input>
        </div>
    </div>
</div>

<script>
    var word_array = [
        {% for key, value in tags.items() %}
            {text: {{ key|tojson|safe }}, weight: {{ value }}, html: {"class": "tag-cloud-tag"}},
        {% endfor %}
    ];

    $.fn.enterKey = function (fnc) {
        return this.each(function () {
            $(this).keypress(function (ev) {
                var keycode = (ev.keyCode ? ev.keyCode : ev.which);
                if (keycode == '13') {
                    fnc.call(this, ev);
                }
            })
        })
    };

    $(function () {
        $('#inputDescription').maxlength();

        $("#tag-cloud").jQCloud(word_array, {
            removeOverflowing: false,
            afterCloudRender: function () {
                $(".tag-cloud-tag").hover(function (e) {
                    console.log('hover tag ' + e.target);
                }).click(function (e) {
                    console.log('click tag ' + e.target);
                    var tag = $(this).text();
                    var index = parseInt($(this).attr('id').split("_").pop());
                    BootstrapDialog.confirm("Add you sure to upvote " + tag + "?", function (result) {
                        if (result) {
                            voteTag(tag, index);
                        }
                    });
                });
            }
        });

        function voteTag(tag, index) {
            $.get('/api/add_tag', {taggee: "{{ friend.id }}", tag: tag}, function (response) {
                if (response['succeed']) {
                    word_array[index]['weight']++;
                    $('#tag-cloud').jQCloud('update', word_array);
                } else {
                    BootstrapDialog.show({
                        title: 'Error',
                        message: response['message']
                    });
                }
            });
        }


        function addTag(tag) {
            if (($.map(word_array, function (e) {
                        return e.text
                    }).indexOf(tag.toLowerCase())) > -1) {
                BootstrapDialog.show({
                    title: 'Error',
                    message: 'Cannot add existing tag'
                });
                return;
            }
            $.get('/api/add_tag', {taggee: "{{ friend.id }}", tag: tag}, function (response) {
                if (response['succeed']) {
                    word_array.push({text: tag, weight: 1, html: {"class": "tag-cloud-tag"}});
                    $('#tag-cloud').jQCloud('update', word_array);
                } else {
                    BootstrapDialog.show({
                        title: 'Error',
                        message: response['message']
                    });
                }
            });
        }

        $("#inputDescription").enterKey(function () {
            var tag = $(this).val();
            if (($.map(word_array, function (e) {
                        return e.text
                    }).indexOf(tag.toLowerCase())) > -1) {
                BootstrapDialog.show({
                    title: 'Error',
                    message: 'Cannot add existing tag'
                });
                return;
            }
            BootstrapDialog.confirm("Add you sure to add " + tag + "?", function (result) {
                if (result) {
                    addTag(tag);
                }
            });
            $(this).val('');
        });
    })
</script>