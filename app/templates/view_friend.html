<div id="view-friend" class="view">
    <div class="row">
        <div class="profile-name">{{ friend.name }}</div>
    </div>

    <div class="row">
        <div id="tag-cloud" style="width: 100%; height: 250px;"></div>
        <img class="profile-pic" src="https://graph.facebook.com/{{ friend.id }}/picture?type=large"
             alter="profile pic">
    </div>

    <div class="row">
        <div class="profile-selectbar">
            <input class="profile-add-tag-input" id="inputDescription" placeholder="Add more tag..."/>
            <button type="button" class="btn btn-warning" id="btnSubmit">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Submit
            </button>
        </div>
    </div>
</div>

<script>
    var word_array = [
        {% for key, value in tags.items() %}
            {text: {{ key|tojson|safe }}, weight: {{ value[0] }}, html: {"class": "tag-cloud-tag {{ 'tagged' if value[1] else '' }}"  }},
        {% endfor %}
    ];

    /*$.fn.enterKey = function (fnc) {
     return this.each(function () {
     $(this).keypress(function (ev) {
     var keycode = (ev.keyCode ? ev.keyCode : ev.which);
     if (keycode == '13') {
     fnc.call(this, ev);
     }
     })
     })
     };*/

    $(function () {
        //$('#inputDescription').maxlength();

        function updateCloud(word_array) {
            $("#tag-cloud").jQCloud(word_array, {
                removeOverflowing: true,
                shape: 'rectangular',
                afterCloudRender: function () {
                    $(".tag-cloud-tag").each(function (index, value) {
                        $(this).attr('data-name', $(this).text());
                    });
                    $(".tag-cloud-tag").hover(function (e) {
                        // console.log('hover tag ' + e.target);
                    }).click(function (e) {
                        /*console.log('click tag ' + e.target);
                         var tag = $(this).text();
                         var index = parseInt($(this).attr('id').split("_").pop());
                         BootstrapDialog.confirm("Add you sure to upvote " + tag + "?", function (result) {
                         if (result) {
                         voteTag(tag, index);
                         }
                         });*/
{#                        $('#inputDescription').tagsinput('add', $(this).text());#}
                    }).dblclick(function (e) {
                        $(document).trigger("viewChanging", ["tag", {'name': $(this).text() }]);
                    });
                    $(".tag-cloud-tag:not(.btnSubmit)").click(function (e) {
                        $('#inputDescription').tagsinput('add', $(this).text());
                    })
                }
            });
        }

        updateCloud(word_array);

        $('#inputDescription').tagsinput({maxChars: 32, trimValue: true});

        $('#btnSubmit').click(function () {
            var tags = JSON.stringify($('#inputDescription').tagsinput('items'));
            $.get('/api/add_tags', {taggee: "{{ friend.id }}", tags: tags}, function (response) {
                if (response['succeed']) {
                    if (response['response'].length < 1) {
                        BootstrapDialog.show({
                            title: 'Error',
                            message: 'No tag added since you added them already'
                        });
                        return;
                    }
                    $.each(response['response'], function (index, value) {
                        var $tag = $("#tag-cloud").find('[data-name="' + value + '"]');
                        console.log($(".tag-cloud-tag").first().attr('data-name'));
                        console.log($tag);
                        if ($tag.length > 0) {
                            var index = parseInt($tag.attr('id').split("_").pop());
                            $tag.addClass('tagged');
                            word_array[index]['weight']++;
                        } else {
                            word_array.push({text: value, weight: 1, html: {"class": "tag-cloud-tag tagged"}});
                        }
                    });
                    $('#tag-cloud').jQCloud('update', word_array);
                } else {
                    BootstrapDialog.show({
                        title: 'Error',
                        message: response['message']
                    });
                }
            });
        });

        /*function voteTag(tag, index) {
         $.get('/api/add_tag', {taggee: "
        {{ friend.id }}", tag: tag}, function (response) {
         if (response['succeed']) {
         word_array[index]['weight']++;
         $('#tag-cloud').jQCloud('update', word_array);
         } else {
         BootstrapDialog.show({
         title: 'Error',
         message: response['message']
         });
         }
         });
         }


         function addTag(tag) {
         if (($.map(word_array, function (e) {
         return e.text
         }).indexOf(tag.toLowerCase())) > -1) {
         BootstrapDialog.show({
         title: 'Error',
         message: 'Cannot add existing tag'
         });
         return;
         }
         $.get('/api/add_tag', {taggee: "
        {{ friend.id }}", tag: tag}, function (response) {
         if (response['succeed']) {
         word_array.push({text: tag, weight: 1, html: {"class": "tag-cloud-tag"}});
         $('#tag-cloud').jQCloud('update', word_array);
         } else {
         BootstrapDialog.show({
         title: 'Error',
         message: response['message']
         });
         }
         });
         }

         $("#inputDescription").enterKey(function () {
         var tag = $(this).val();
         if (($.map(word_array, function (e) {
         return e.text
         }).indexOf(tag.toLowerCase())) > -1) {
         BootstrapDialog.show({
         title: 'Error',
         message: 'Cannot add existing tag'
         });
         return;
         }
         BootstrapDialog.confirm("Add you sure to add " + tag + "?", function (result) {
         if (result) {
         addTag(tag);
         }
         });
         $(this).val('');
         });*/

        var allTags = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.whitespace,
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/api/search_tags?keyword=%QUERY',
                wildcard: '%QUERY',
                transform: function (response) {
                    return response['response']
                }
            }
        });

        //$('#inputDescription').typeahead({highlight: true}, {source: allTags});
    })
</script>
